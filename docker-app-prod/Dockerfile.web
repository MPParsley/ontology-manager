FROM node:10-stretch

RUN npm install --global npm@6.4.1

RUN apt-get update
RUN apt-get install -qy apt-transport-https
RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
RUN echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
RUN apt-get update && apt-get -qy --no-install-recommends install yarn

# Create app directory
RUN mkdir -p /usr/src/app
WORKDIR /usr/src/app

COPY . /usr/src/app/
RUN node -v && yarn

# all these variables should be set in the env where the build gets executed
# and passed using --build-arg
ARG POSTGRESQL_PASSWORD
ARG POSTGRESQL_DATABASE
ARG POSTGRESQL_HOST

ARG POSTGRAPHILE_TOKEN_SECRET
ARG POSTGRESQL_POSTGRAPHILE_PASSWORD

ARG OAUTH_TOKEN_SECRET
ARG OAUTH_HOST
ARG OAUTH_CLIENT_ID
ARG OAUTH_CLIENT_SECRET

ARG GITHUB_PERSONAL_ACCESS_TOKEN

ARG EDITOR_HOST

ENV BUILDING_WITHOUT_PG_ACCESS=yes

# Build app
RUN npm run build

ENV BUILDING_WITHOUT_PG_ACCESS=

ENV HOST 0.0.0.0
EXPOSE 3000

# entrypoint
RUN cp docker-app-prod/entrypoint.web.sh /usr/src/app/entrypoint.web.sh
RUN chmod 755 /usr/src/app/entrypoint.web.sh

ENTRYPOINT [ "/usr/src/app/entrypoint.web.sh"]
